<div align="center">

# ComfyUI_Gradio 图像处理工具集

![Version](https://img.shields.io/badge/version-1.1.0-blue)
![Python](https://img.shields.io/badge/Python-≥3.10-blue)
![License](https://img.shields.io/badge/license-MIT-brightgreen)

基于 Gradio 开发的 ComfyUI 图像处理工具集，提供直观的 Web 界面进行高质量图像处理操作。
集成多种 AI 图像处理功能，一站式解决背景移除、图像放大、物体移除、局部重绘等需求。

</div>

## 📋 目录

- [功能概览](#-功能概览)
- [快速开始](#-快速开始)
- [详细功能说明](#-详细功能说明)
  - [背景移除](#背景移除)
  - [图片放大](#图片放大)
  - [物体移除](#物体移除)
  - [手动蒙版物体移除](#手动蒙版物体移除)
  - [图片扩展](#图片扩展)
  - [局部重绘](#局部重绘)
  - [物体替换](#物体替换)
  - [人脸替换](#人脸替换)
- [配置详解](#-配置详解)
- [性能优化](#-性能优化)
- [问题排查](#-问题排查)
- [开发者文档](#-开发者文档)
- [相关资源](#-相关资源)
- [许可证与鸣谢](#-许可证与鸣谢)

## ✨ 功能概览

本工具集提供以下图像处理功能，每个功能都可以独立访问或通过集成界面使用：

| 功能 | 描述 | 端口 | 特点 |
|------|------|------|------|
| 🔄 集成应用 | 将所有功能整合到一个界面，通过顶部导航切换 | 7899 | 一站式操作，便捷切换 |
| 🔍 背景移除 | 自动识别并移除图片背景，生成透明背景图片 | 7860 | 智能边缘检测，支持偏移调整 |
| ⚡ 图片放大 | 提高图片分辨率和清晰度，支持重绘幅度调整 | 7870 | 4倍超分辨率，细节增强 |
| 🗑️ 物体移除 | 通过文本描述自动移除图片中的物体 | 7880 | 智能识别，无缝填充 |
| ✏️ 手动蒙版物体移除 | 手动绘制蒙版精确移除目标区域 | 7881 | 精确控制，适合复杂场景 |
| 🔍 图片扩展 | 向图片四周扩展内容，生成更大尺寸的图片 | 7890 | 智能场景延伸，无缝衔接 |
| 🎨 局部重绘 | 通过提示词重绘图片区域，支持中文输入 | 7891 | 局部精修，保留整体风格 |
| 🔄 物体替换 | 将图片中的物体替换为其他内容 | 7892 | 智能融合，保持光影一致 |
| 👤 人脸替换 | 智能替换图像中的人脸 | 7893 | 保留表情，自然融合 |

## 🚀 快速开始

### 环境要求

- Python >= 3.10
- ComfyUI 服务（需已安装并能正常运行）
- 6GB+ 显存的 NVIDIA GPU（推荐）

### 安装与配置

1. **克隆项目**
```bash
git clone https://github.com/your-username/ComfyUI_Gradio.git
cd ComfyUI_Gradio
```

2. **安装依赖**
```bash
pip install -r requirements.txt
```

3. **配置文件设置**
```bash
# 创建并编辑配置文件
cp config/config.yaml.example config/config.yaml
```

**配置文件核心设置**：
```yaml
comfyui_server:
  url: "http://127.0.0.1:8188/prompt"  # ComfyUI API地址

paths:
  input_dir: "{YOUR_ComfyUI_Input_Dir}"  # ComfyUI输入目录
  output_dir: "{YOUR_ComfyUI_Output_Dir}"  # ComfyUI输出目录
```

4. **启动服务**
```bash
python start.py
```

启动后访问 `http://127.0.0.1:7899` 打开集成应用界面。

> **一键启动**：首次配置后，之后只需运行 `python start.py` 即可启动所有服务。

### Docker 部署（可选）

```bash
# 构建镜像
docker build -t comfyui-gradio .

# 运行容器
docker run -p 7899:7899 -v /path/to/config:/app/config comfyui-gradio
```

## 📖 详细功能说明

### 背景移除

自动识别并移除图片背景，生成透明背景图片。基于 RMBG-2.0 模型，精确识别边缘。

**工作原理**：使用深度学习模型自动识别前景与背景，生成高精度遮罩，提取前景对象。

**使用方法**：
1. 上传需要处理的图片
2. 调整遮罩偏移量（-10 到 10，正值扩大遮罩，负值缩小遮罩）
3. 点击"开始处理"按钮
4. 处理完成后下载透明背景的图片（PNG格式）

**最佳实践**：
- 对于复杂背景的图片，建议调整遮罩偏移为正值（1-3）
- 对于发丝等细节丰富的图片，请使用原尺寸处理以保留细节

### 图片放大

提高图片分辨率和清晰度，基于最新的AI超分辨率技术，可实现4倍放大且保留细节。

**工作原理**：结合超分辨率和生成式AI技术，在放大过程中填补细节，避免传统算法的模糊和锯齿。

**使用方法**：
1. 上传需要放大的图片
2. 调整重绘幅度（0-1，默认0.25）
   - 值越小越接近原图
   - 值越大细节重绘越多
3. 点击"开始处理"按钮
4. 处理完成后下载高清放大图片

**注意事项**：
- 超过1600像素的图片会自动缩放以优化处理速度
- 重绘幅度建议从小到大尝试，避免过度修改原始图片风格

### 物体移除

通过文本描述自动识别并移除图片中的物体，并智能填充背景。

**工作原理**：结合图像分割和生成式填充技术，自动识别目标物体并创建无缝背景。

**使用方法**：
1. 上传图片
2. 输入要移除的物体描述（如"手表"、"文字"、"桌子"等）
3. 调整遮罩扩展值（可选，用于微调识别区域大小）
4. 点击"开始处理"按钮
5. 处理完成后下载结果图片

**技巧**：
- 尽可能使用具体描述，如"红色手表"比"手表"更精确
- 对于未被准确识别的物体，可尝试使用手动蒙版功能

### 手动蒙版物体移除

通过手动绘制蒙版精确控制需要移除的区域，适用于复杂场景或特定区域处理。

**工作原理**：用户手动标记需要移除的区域，系统分析周围环境进行智能填充。

**使用方法**：
1. 上传图片
2. 使用绘图工具在需要移除的区域上绘制蒙版
3. 调整遮罩扩展值（可选，用于扩大处理区域）
4. 点击"开始处理"按钮
5. 处理完成后下载移除物体后的图片

**最佳实践**：
- 蒙版边缘建议略微超出目标物体，确保完全移除
- 复杂场景下可分多次处理不同区域，效果更佳

### 图片扩展

向图片四周扩展内容，生成更大尺寸的图片，适用于补充图片边缘或改变构图。

**工作原理**：分析原始图片内容和边缘信息，使用AI生成技术创建连贯的扩展区域。

**使用方法**：
1. 上传图片
2. 输入扩展内容描述（如"蓝天"、"草地"等）
3. 设置四个方向（上、下、左、右）的扩展像素值
4. 点击"开始处理"按钮
5. 处理完成后下载扩展后的图片

**技巧**：
- 描述词越具体，扩展内容越符合预期
- 建议一次扩展不超过原图50%的尺寸，以保证最佳效果

### 局部重绘

通过提示词重绘图片中的特定区域，支持中文输入，可用于修复、美化或创意改变。

**工作原理**：保留原图大部分内容，仅针对标记区域进行定向生成，确保整体风格一致。

**使用方法**：
1. 上传图片
2. 用黑色画笔在图片上标记需要重绘的区域
3. 输入提示词，描述希望重绘的内容（支持中文）
4. 调整重绘幅度，控制与原图风格的融合度
5. 点击"开始处理"按钮
6. 处理完成后下载重绘后的图片

**应用场景**：
- 修复老照片损坏区域
- 替换图片中不满意的局部内容
- 创意性改变图片元素

### 物体替换

将图片中的物体替换为其他内容，保持场景协调性，支持中文输入。

**工作原理**：结合图像识别和条件生成技术，在保留原始场景光照和风格的情况下替换目标物体。

**使用方法**：
1. 上传源图片
2. 在源图片上绘制要替换的区域
3. 输入物体描述（如"一只猫"、"红色跑车"等，支持中文）
4. 点击"开始处理"按钮
5. 处理完成后下载替换后的图片

**最佳实践**：
- 替换物体尺寸与原物体接近时效果最佳
- 描述中可加入颜色、材质等细节以获得更精准的替换效果

### 人脸替换

智能替换图像中的人脸，保留表情和角度，实现自然融合。

**工作原理**：检测人脸关键点，进行精确对齐和融合，保持原有表情和光影。

**使用方法**：
1. 上传源图片（含有要替换的人脸）
2. 上传目标人脸图片
3. 调整融合强度（可选）
4. 点击"开始处理"按钮
5. 处理完成后下载人脸替换后的图片

**注意事项**：
- 角度相似的人脸替换效果最佳
- 建议使用清晰、正面的人脸照片作为目标

## ⚙️ 配置详解

配置文件位于 `config/config.yaml`，包含以下主要配置项：

### 核心配置

```yaml
# ComfyUI 服务配置
comfyui_server:
  url: "http://127.0.0.1:8188/prompt"  # ComfyUI API地址
  timeout: 30  # 请求超时时间(秒)

# 路径配置
paths:
  input_dir: "{YOUR_ComfyUI_Input_Dir}"  # ComfyUI输入目录
  output_dir: "{YOUR_ComfyUI_Output_Dir}"  # ComfyUI输出目录
```

### 服务器配置

```yaml
# Gradio 服务器配置
gradio_server:
  server_name: "0.0.0.0"  # 服务器地址，使用0.0.0.0可从外部访问
  share: false  # 是否共享到公网
  integrated_app_port: 7899  # 集成应用端口
  rmbg_server_port: 7860  # 背景移除服务端口
  image_upscale_server_port: 7870  # 图片放大服务端口
  remove_object_server_port: 7880  # 物体移除服务端口
  manual_remove_object_server_port: 7881  # 手动蒙版物体移除服务端口
  image_extend_server_port: 7890  # 图片扩展服务端口
  fill_repaint_server_port: 7891  # 局部重绘服务端口
  fill_replace_server_port: 7892  # 物体替换服务端口
  swap_face_server_port: 7893  # 人脸替换服务端口
```

### 图像处理配置

```yaml
# 图像处理配置
image_processing:
  max_size: 1600  # 图像的最大尺寸（宽度或高度），超过这个尺寸将自动缩放
  keep_aspect_ratio: true  # 缩放时是否保持宽高比
  jpeg_quality: 95  # JPEG导出质量
  png_compression: 4  # PNG压缩级别（0-9）
```

### 通知配置

```yaml
# 钉钉推送配置
dingtalk:
   enabled: true  # 是否启用钉钉推送
   webhook: "https://oapi.dingtalk.com/robot/send?access_token=xxx"
   secret: "xxx"  # 安全设置的签名密钥
```

## 🚀 性能优化

### 图像尺寸控制

- **大尺寸图片处理**：系统默认对超过1600像素的图片进行自动缩放处理，以平衡效果和速度
- **调整缩放阈值**：可以在配置文件中修改 `image_processing.max_size` 值调整缩放阈值

### 内存优化

- **批量处理控制**：避免同时处理多张高分辨率图片
- **定期重启**：对于长时间运行的服务，建议每隔24小时重启一次，避免内存泄漏

### GPU 利用率

- **调整模型精度**：对于显存受限的设备，可考虑使用半精度(FP16)模式
- **队列处理**：高负载场景下启用队列处理模式，避免GPU过载

### 增强处理速度

- **预热处理**：服务启动后先处理一张测试图片，加载模型到内存
- **调整批处理大小**：对于多张相似图片处理，调整批处理参数可提高整体效率

## ❓ 问题排查

### 常见问题与解决方案

| 问题 | 可能原因 | 解决方法 |
|------|---------|---------|
| 服务无法启动 | ComfyUI未运行 | 确保ComfyUI服务已启动并在8188端口可访问 |
| 处理超时 | 图片过大或GPU资源不足 | 缩小图片尺寸或增加超时时间配置 |
| 处理结果模糊 | 图片被过度缩放 | 调整配置中的最大尺寸阈值或禁用自动缩放 |
| 内存错误 | GPU显存不足 | 降低图片分辨率，关闭其他GPU程序 |
| 功能页面无响应 | 对应服务未正确启动 | 检查日志确认服务状态，手动重启服务 |

### 日志查看指南

- 服务日志位于 `logs/` 目录
- 各功能服务有独立日志文件
- 错误日志包含详细调用信息，便于定位问题
- 使用 `scripts/log_manager.py` 工具查看归档日志

### 错误报告渠道

如遇无法解决的问题，请通过以下方式反馈：
- GitHub Issues: [提交问题](https://github.com/your-username/ComfyUI_Gradio/issues)

## 💻 开发者文档

### 架构概述

ComfyUI_Gradio采用微服务架构，每个功能独立运行在不同端口，架构图如下：

```
                    ┌─────────────┐
                    │  集成应用   │
                    │  (7899)    │
                    └─────┬───────┘
                          │
         ┌───────────────┴┬──────────────┬──────────────┬──────────────┐
┌────────▼─────┐  ┌───────▼────┐  ┌──────▼─────┐  ┌────▼─────────┐  ┌─▼──────────┐
│ 背景移除    │  │ 图片放大   │  │ 物体移除   │  │局部重绘      │  │其他服务    │
│ (7860)     │  │ (7870)     │  │ (7880)     │  │(7891)        │  │            │
└──────┬──────┘  └─────┬──────┘  └──────┬─────┘  └─────┬────────┘  └─────┬──────┘
       │               │               │               │                 │
       └───────────────┴───────────────┴───────────────┴─────────────────┘
                                      │
                              ┌───────▼────────┐
                              │   ComfyUI      │
                              │   (8188)       │
                              └────────────────┘
```

### 添加新功能

1. **创建服务文件**：
   - 在 `comfyui_gradio/services/` 目录下创建新的Python文件
   - 参考现有服务实现接口

2. **添加工作流文件**：
   - 在 `workflows/` 目录中添加对应的ComfyUI工作流JSON文件

3. **注册服务**：
   - 在 `comfyui_gradio/server.py` 的 `ServiceManager` 类中注册新服务
   - 在 `comfyui_gradio/app.py` 中添加新功能的UI界面

### API 文档

内部API遵循以下格式：
- 服务类必须实现 `process_image` 方法
- UI组件通过 `create_interface` 函数创建
- 错误处理通过 `error_reporter` 统一管理

### 贡献指南

1. Fork 项目仓库
2. 创建特性分支 (`git checkout -b feature/amazing-feature`)
3. 提交更改 (`git commit -m 'Add some amazing feature'`)
4. 推送到分支 (`git push origin feature/amazing-feature`)
5. 创建 Pull Request

## 🔗 相关资源

- [ComfyUI 项目](https://github.com/comfyanonymous/ComfyUI)
- [Gradio 文档](https://gradio.app/)
- [RMBG-2.0 模型](https://github.com/username/rmbg-model)
- [图像超分辨率技术](https://example.com/super-resolution)

## 📄 许可证与鸣谢

### 开源许可

本项目采用 [MIT License](LICENSE) 开源。

### 核心依赖

- [ComfyUI](https://github.com/comfyanonymous/ComfyUI) - AI图像处理框架
- [Gradio](https://gradio.app/) - Python Web界面库
- [Pillow](https://python-pillow.org/) - 图像处理库
- [PyYAML](https://pyyaml.org/) - YAML解析库
